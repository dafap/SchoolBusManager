<?php
/**
 * Page d'entrée dans l'espace Parents
 * 
 * @project sbm
 * @package SbmParent/view/sbm-parent/index
 * @filesource index.phtml
 * @encodage UTF-8
 * @author DAFAP Informatique - Alain Pomirol (dafap@free.fr)
 * @date 13 févr. 2015
 * @version 2015-1
 */
use SbmCommun\Model\DateLib;
$this->headLink()->appendStylesheet($this->basePath('/css/fam-icons-custom.css'));
$this->headLink()->prependStylesheet($this->basepath('/js/jquery-ui-1.11.4.custom/jquery-ui.min.css'));
$this->headScript()->appendFile($this->basepath('/js/jquery.min.js'));
$this->headScript()->appendFile($this->basepath('/js/jquery-ui-1.11.4.custom/jquery-ui.min.js'));
$this->headScript()->captureStart();
?>
$(document).ready(function($){
$("#help-preinscrits").trigger("click");
$("#help-preinscrits").on("click", function(){
    var content = $("#help-preinscrits-content").html();
    $("#winpopup").dialog({
            draggable:true,
            modal: true,
            autoOpen: false,
            height:400,
            width:610,
            resizable: false,
            title: $(this).attr('title')
            //appendTo: content
        });
    $("#winpopup-content").html(content);
    $("#winpopup").dialog("open");
});
});
<?php
$this->headScript()->captureEnd();

$montantTotal = 0;
$fmt = new NumberFormatter('fr_FR', NumberFormatter::CURRENCY);
$enAttente = false;

$nbPreinscrits = $this->preinscrits->count();
$nbInscrits = $this->inscrits->count();
$nbPaiements = $this->paiements->count();
$etat = $this->etatSite['etat'];
$dateLimite = $this->etatSite['echeance']->format('d/m/Y');
$url_ajoutEleve = $this->url('sbmparent', array(
    'action' => 'inscription-eleve'
));
$url_payer = $this->url('sbmpaiement', array(
    'action' => 'formulaire'
));
?>
<div id="winpopup">
	<div id="winpopup-content"
		style="margin-left: 30px; margin-right: 30px;"></div>
</div>
<div class="flashMessenger float-right">
<?php
echo $this->flashMessenger()->render('success');
echo $this->flashMessenger()->render('warning');
echo $this->flashMessenger()->render('error');
echo $this->flashMessenger()->render('info');
echo $this->flashMessenger()->render('default');
?>
</div>
<h1>Espace parent</h1>
<?php if ($nbInscrits == 0 && $nbPreinscrits == 0) : ?>
<div id="parent-wrapper" class="explication">
	<?php if ($etat == 0) :?>
	<p>Vos enfants ne sont pas inscrits pour l'année scolaire prochaine.</p>
	<p>Vous pourrez inscire vos enfants entre le <?php echo $this->etatSite['dateDebut']->format('d/m/Y');?> et le <?php echo $this->etatSite['dateFin']->format('d/m/Y');?>.</p>
	<?php elseif ($etat == 1) :?>
	<p>Vous n'avez pas encore d'enfant inscrit.</p>
	<p>Inscrivez tous vos enfants qui doivent utiliser le service de transports scolaires puis effectuez le paiement en ligne ou adressez votre paiment au service transport de la Communauté de 
communes du Bassin Decazeville Aubin avant le <?php echo $dateLimite; ?> afin de recevoir votre carte par courrier. Sinon, venez payer et retirer votre carte lors des permanences.</p>
    <ul>
    <?php foreach ($this->permanences as $row) :?>
        <li><?php echo "Pour les habitants de $row";?></li>
    <?php endforeach;?>
    </ul>
	<p>
		<b>Les inscriptions ne seront prises en compte qu'une fois le paiement
			enregistré.</b>
	</p>
	<p>
		Cliquez sur le bouton <b><i>Inscrire un enfant</i></b> pour commencer
		les inscriptions.
	</p>
<?php
        echo $this->listeZoneActions(array(), array(
            'inscrire' => array(
                'class' => 'accueil default',
                'formaction' => $url_ajoutEleve,
                'value' => 'Inscrire un enfant'
            )
        ));
        ?>	<?php else :?>
        <p>Vous n'avez pas d'enfant inscrit.</p>
	<p>Les inscriptions en ligne sont fermées.</p>
	<p>Pour inscrire un enfant, prenez contact avec le service transport de
		la Communauté de communes Decazeville-Aubin. Au delà du <?php echo $dateLimite;?> les
		places seront attribuées à la rentrée en fonction des disponibilités
		dans les cars.</p>
	<?php endif;?>

</div>
<?php else : ?>
<div id="parent-wrapper">
	<div id="parent-inscrits">
    <?php if ($nbInscrits) : ?>
    <fieldset class="sbm-page1">
			<legend>Enfants inscrits</legend>
			<table class="parent eleve">
				<tbody>
					<tr>
						<th>Nom</th>
						<th>Prénom</th>
						<th>Etablissement scolaire</th>
						<th>Commune</th>
						<th>Circuit</th>
						<th>Arrêt</th>
					</tr>
            <?php
        foreach ($this->inscrits as $row) {
            echo '<tr class="' . $this->cycle(array(
                "odd",
                "even"
            ))->next() . '"><td>' . $row['nom'] . '</td><td>' . $row['prenom'] . '</td><td>' . $row['etablissement'] . '</td><td>' . $row['communeEtablissement'] . '</td>';
            $reseau = $this->affectations->getCorrespondances($row['eleveId']);
            $station = $circuit = array();
            if ($reseau->count()) {
                foreach ($reseau as $transport) {
                    $circuit[] = $transport['service1Id'] . ' - ' . $transport['transporteur1'];
                    $station[] = $transport['station1'] . ' - ' . $transport['commune1'];
                    if (! empty($transport['service2Id'])) {
                        $circuit[] = $transport['service2Id'] . ' - ' . $transport['transporteur2'];
                    }
                    if (! empty($transport['station2Id'])) {
                        $circuit[] = $transport['station2'] . ' - ' . $transport['commune2'];
                    }
                }
            }
            echo '<td>' . implode('<br />', $circuit) . '</td><td>' . implode('<br />', $station) . '</td>';
            // echo '<td></td><td></td>';
            
            echo '</tr>';
        }
        ?>
            </tbody>
			</table>
		</fieldset>
		<p class="sbm-description">
			La carte des circuits et les horaires seront consultables ici à partir de la dernière semaine d'août.
		</p>
    <?php endif; ?>
    </div>
	<div id="parent-preinscrits">
    <?php if ($nbPreinscrits) : ?>
    <fieldset class="sbm-page1">
			<legend>Enfants préinscrits</legend>
			<table class="parent eleve">
				<tbody>
					<tr>
						<th>Nom</th>
						<th>Prénom</th>
						<th>Etablissement scolaire</th>
						<th>Commune</th>
						<th>Tarif</th>
					</tr>
            <?php
        foreach ($this->preinscrits as $row) {
            $peutPayer = max($row['distanceR1'], $row['distanceR2']) >= 1.0 && ($row['district'] == 1 || $row['derogation'] == 1);
            if ($row['selectionScolarite']) {
                $montantUnitaire = 'en attente';
                $enAttente = true;
            } elseif ($peutPayer) {
                $montantUnitaire = $fmt->formatCurrency($this->montant, 'EUR');
                $montantTotal += $this->montant;
            } else {
                $montantUnitaire = '<span class="exces" title="Prenez contact avec le service des transports à la CCDA">pas de droit au transport scolaire</span>';
                $enAttente = true;
            }
            $url_edit = $this->url('sbmparent', array(
                'action' => 'edit-eleve'
            ));
            $url_delete = $this->url('sbmparent', array(
                'action' => 'suppr-eleve'
            ));
            $url_attente = $this->url('sbmparent', array(
                'action' => 'attente-eleve'
            ));
            $hiddens = array(
                'id' => $row['eleveId']
            );
            if ($etat == 1) {
                $buttons = array(
                    'modifier' => array(
                        'class' => 'button default left-10px',
                        'formaction' => $url_edit,
                        'title' => 'modifier la scolarité de ' . $row['prenom'],
                        'value' => 'Modifier'
                    ),
                    'supprimer' => array(
                        'class' => 'button default left-10px',
                        'formaction' => $url_delete,
                        'title' => 'supprimer l\'incription de ' . $row['prenom'],
                        'value' => 'Supprimer'
                    )
                );
                if ($peutPayer) {
                    $attenteValue = $row['selectionScolarite'] ? 'Reprendre cet enfant' : 'Mettre en attente';
                    $attenteTitle = $row['selectionScolarite'] ? 'Remettre ' . $row['prenom'] . ' dans' : 'Retirer ' . $row['prenom'] . ' de';
                    $attenteTitle .= ' la liste des inscriptions à payer';
                    $buttons['attente'] = array(
                        'class' => 'button default left-10px',
                        'formaction' => $url_attente,
                        'title' => $attenteTitle,
                        'value' => $attenteValue
                    );
                }
            } else {
                $buttons = array();
            }
            $btligne = $this->listeLigneActions($row['eleveId'], $hiddens, $buttons);
            $modeleligne = '<tr class="%s"><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>';
            echo sprintf($modeleligne, $this->cycle(array(
                "odd",
                "even"
            ))->next(), $row['nom'], $row['prenom'], $row['etablissement'], $row['communeEtablissement'], $montantUnitaire, $btligne);
        }
        ?>
            </tbody>
				<tfoot>
					<tr>
						<th colspan="4">Total à payer</th>
						<th><?php echo $fmt->formatCurrency($montantTotal, 'EUR'); ?></th>
					</tr>
				</tfoot>
			</table>
		</fieldset>
    <?php endif; ?>
    <?php if ($etat == 1):?>
        <div class="bouton-inscrire clearfix">
        <?php
        $boutons = array(
            array(
                'class' => 'button default float-right left-10px',
                'formaction' => $url_ajoutEleve,
                'value' => 'Inscrire un autre enfant'
            )
        );
        if ($montantTotal > 0) {
            if ($enAttente) {
                $payerTitle = "valider et payer toutes les incriptions\nqui ne sont pas en attente.";
            } else {
                $payerTitle = "valider et payer toutes les inscriptions\nde la liste de enfants préinscrits.";
            }
            $boutons['payer'] = array(
                'class' => 'button default float-right left-10px',
                'formaction' => $url_payer,
                'value' => 'Valider la liste et payer',
                'title' => $payerTitle
            );
        }
        echo $this->listeZoneActions(array(
            'montant' => $montantTotal
        ), $boutons);
        ?>
        </div>
    <?php endif;?>
    <?php
    switch ($etat) {
        case 0:
            $msg = '';
            break;
        case 1:
            $msg = "Si vous payez en ligne par carte bancaire <span class=\"important\">vous recevrez aussitôt une facturette par email</span> pour attester de votre paiement.";
            $msg .= " N'oubliez pas de payer ou d'envoyer votre paiement avant le $dateLimite pour recevoir la carte de transport par la poste.";
            $msg .= " Sinon, rendez-vous à la Communauté de communes. Pour les habitant de " . $this->permanences[0] . '.';
            break;
        default:
            $msg = "Pour valider les préinscriptions, rendez-vous à la Communauté de communes le jour de la distribution des cartes. Pour les habitants de ";
            $msg .= $this->permanences[0] . '.';
            break;
    }
    ?>
		<p class="sbm-description">
			<i id="help-preinscrits" title="Comment payer ?" class="fam-help"></i> <?php echo $msg;?>
		</p>
		<div id="help-preinscrits-content" class="invisible">
			<p>Vous pouvez :</p>
			<ul>
				<li style="margin-bottom: 0.4rem;">payer en ligne à l'aide d'une carte bancaire avant le <?php echo $dateLimite;?>. Vous recevrez
					alors une attestation de paiement par email et la carte de transport par la poste.</li>
				<li style="margin-bottom: 0.4rem;">adresser un chèque du montant indiqué à l'adresse ci-dessous avant le <?php echo $dateLimite;?>. 
				Vous recevrez alors la carte de transport par la poste.</li>
				<li>vous rendre à la Communauté de communes (pour les habitant de <?php echo $this->permanences[0];?>) 
				pour payer en espèces ou par chèque et retirer la carte de transport.</li>
			</ul>
			<div class="centre">   
				<?php echo $this->client['name'];?><br>
				<?php echo $this->client['adresse'][0]; ?><br>
				<?php echo $this->client['adresse'][1]; ?><br>
				<?php echo $this->client['code_postal']; ?> <?php echo $this->client['commune']; ?><br> 
				Tél. <?php echo $this->telephone($this->client['telephone']); ?>
		    </div>
		</div>
	</div>
	<div id="parent-paiements">
    <?php if ($nbPaiements) : ?>
    <fieldset class="sbm-page1">
			<legend>Paiements enregistrés</legend>
			<table class="parent paiement">
				<tbody>
					<tr>
						<th>Date du paiement</th>
						<th>Moyen de paiement</th>
						<th>Montant</th>
					</tr>
            <?php
        foreach ($this->paiements as $row) {
            echo '<tr><td>' . DateLib::formatDateTimeFromMysql($row->datePaiement) . '</td><td>' . $row->modeDePaiement . '</td><td>' . $row->montant . '</td></tr>';
        }
        ?>
            </tbody>
			</table>
		</fieldset>
    <?php endif; ?>
    </div>
</div>
<?php endif; ?>