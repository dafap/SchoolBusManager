<?php
/**
 * Page d'entrée dans l'espace Parents - Version Millau Grands Causses
 *
 * Elle dispose des propriétés suivantes :
 * 'theme' : objet SbmInstallation\Model\Theme
 * 'namespacectrl' : controle du namespace
 * 'responsable' : objet responsable créé lors du login
 * 'calendar' : objet SbmCommun\Model\Db\Service\Table\System\Calendar
 * 'inscrits' : résultat de la requête Sbm\Db\Query\ElevesScolarites::getElevesInscrits()
 * 'preinscrits' => résultat de la requête
 * Sbm\Db\Query\ElevesScolarites::getElevesPreinscritsOuEnAttente()
 * 'affectations' => résultat de la requête Sbm\Db\Query\AffectationsServicesStations
 * 'resultats' => objet SbmCommun\Model\Paiement\resultats présentant les justificatifs
 * des sommes dues
 * 'paiements' => ensemble des paiements enregistrés pour ce parent durant cette année
 * scolaire
 * 'factures' => ensemble des factures enregistrées pour ce parent durant cette année
 * scolaire
 * 'client' : tableau décrivant l'organisateur (array)
 * 'accueil' : url du site de l'organisateur
 * 'adresse' : tableau de l'adresse du parent
 *
 * @project sbm
 * @package SbmParent/view/sbm-parent/index
 * @filesource index.phtml
 * @encodage UTF-8
 * @author DAFAP Informatique - Alain Pomirol (dafap@free.fr)
 * @date 28 juin 2021
 * @version 2021-2.5.11
 */
use SbmBase\Model\DateLib;
use SbmBase\Model\Session;
use SbmCommun\Model\Paiements\GrilleTarifInterface;

$this->headLink()->appendStylesheet($this->basePath('/css/fam-icons-custom.css'));
$this->themeCss('sbm-parent/index', 'index.css');
$this->jQuery('jquery-ui');
$this->themeJS('sbm-parent', 'index.js');
$fmt = new NumberFormatter('fr_FR', NumberFormatter::CURRENCY);
// initialisation nécessaire pour le popup help-preinscrits-content :
$permanences = '';
$payerMsg = false;
$adresse_organisateur = implode(', ',
    [
        $this->client['name'],
        implode(', ', $this->client['adresse']),
        sprintf('%s %s', $this->client['code_postal'], $this->client['commune'])
    ]);
$nbPreinscrits = $this->preinscrits->count();
$nbInscrits = $this->inscrits->count();
$nbPaiements = $this->paiements->count();
$etatDuSite = $this->calendar->getEtatDuSite();
// pour sadmin, autoriser les inscriptions et le paiement
if ($this->sadmin) {
    $etatDuSite['etat'] = $this->calendar::ETAT_PENDANT;
    $etatDuSite['inscription'] = true;
}
$dateFin = $etatDuSite['dateFin']->format('d/m/Y');
$date_fin_aout = (new \DateTime(Session::get('as')['dateDebut']))->modify('8 days ago');
$avant_fin_aout = '';
if ((new \DateTime()) < $date_fin_aout) {
    $avant_fin_aout = 'invisible';
}
$url_ajoutEleve = $this->url('sbmparent', [
    'action' => 'reinscription-eleve'
]);
$url_payer = $this->url('sbmpaiement', [
    'action' => 'formulaire'
]);
$url_horaires = $this->url('sbmparent', [
    'action' => 'horaires'
]);
$url_envoi_photo = $this->url('sbmparent', [
    'action' => 'envoiphoto'
]);
$url_edit = $this->url('sbmparent', [
    'action' => 'edit-eleve'
]);
$url_delete = $this->url('sbmparent', [
    'action' => 'suppr-eleve'
]);
$url_attente = $this->url('sbmparent', [
    'action' => 'attente-eleve'
]);
$url_facture = $this->url('sbmdocument', [
    'action' => 'facture'
]);
?>
<div id="winpopup">
	<div id="winpopup-content"
		style="margin-left: 30px; margin-right: 30px;"></div>
</div>
<div class="flashMessenger float-right">
<?=$this->flashMessenger()->render('success');?>
<?=$this->flashMessenger()->render('warning');?>
<?=$this->flashMessenger()->render('error');?>
<?=$this->flashMessenger()->render('info');?>
<?=$this->flashMessenger()->render('default');?>
</div>
<h1>Espace parent</h1>
<?php if ($nbInscrits == 0 && $nbPreinscrits == 0) : ?>
<div id="parent-wrapper" class="explication">
	<?php
    switch ($etatDuSite['etat']) {
        case $this->calendar::ETAT_AVANT:
            echo include $this->theme->getIncludeView('sbm-parent/index/index-avant');
            break;
        case $this->calendar::ETAT_PENDANT:
            echo include $this->theme->getIncludeView('sbm-parent/index/index-pendant');
            break;
        case $this->calendar::ETAT_APRES:
            echo include $this->theme->getIncludeView('sbm-parent/index/index-apres');
            break;
        default:
            echo include $this->theme->getIncludeView('sbm-parent/index/index-ferme');
            break;
    }
    ?>
</div>
<?php else : ?>
<div id="parent-wrapper">
	<div id="parent-inscrits">
    <?php if ($nbInscrits) : ?>
    <fieldset class="sbm-page1">
			<legend>Enfants inscrits</legend>
			<table class="parent eleve">
				<tbody>
					<tr>
						<th>Nom</th>
						<th>Prénom</th>
						<th>Etablissement scolaire</th>
						<th>Commune</th>
						<th class="<?=$avant_fin_aout?>">Circuit</th>
						<th class="<?=$avant_fin_aout?>">Arrêt</th>
						<th></th>
					</tr>
        <?php
        $photo_manquante = false;
        foreach ($this->inscrits as $row) {
            $hiddens_ligne = [];
            $photo_manquante |= ! $row['hasphoto'];
            $reseau = $this->affectations->getCorrespondances($row['eleveId']);
            $nbAffectations = $reseau->count();
            $circuit = $station = $entity = [];
            $msgphoto = $row['hasphoto'] ? '' : 'Pas de photo';
            if ($nbAffectations) {
                // construction des tableaux $entity, $station et $circuit sans doublons
                foreach ($reseau as $transport) {
                    $service_transporteur = $transport['service1Id'] . ' - ' .
                        $transport['transporteur1'];
                    $station_commune = $transport['station1'] . ' - ' .
                        $transport['commune1'];
                    $circuitId = $transport['circuit1Id'];
                    $key = md5(
                        sprintf('%s;%s;%d', $service_transporteur, $station_commune,
                            $circuitId));
                    $entity[$key] = $service_transporteur;
                    $station[$key] = $station_commune;
                    $circuit[$key] = $circuitId;
                    $correspondance = ! empty($transport['service2Id']) ||
                        ! empty($transport['station2Id']);
                    if ($correspondance) {
                        if (! empty($transport['service2Id'])) {
                            $service_transporteur = $transport['service2Id'] . ' - ' .
                                $transport['transporteur2'];
                        } else {
                            $service_transporteur = '';
                        }
                        if (! empty($transport['station2Id'])) {
                            $station_commune = $transport['station2'] . ' - ' .
                                $transport['commune2'];
                        } else {
                            $station_commune = '';
                        }
                        if (! empty($transport['circuit2Id'])) {
                            $circuitId = $transport['circuit2Id'];
                        } else {
                            $circuitId = 0;
                        }
                        $key = md5(
                            sprintf('%s;%s;%d', $service_transporteur, $station_commune,
                                $circuitId));
                        $entity[$key] = $service_transporteur;
                        $station[$key] = $station_commune;
                        $circuit[$key] = $circuitId;
                    }
                }
                $entity = array_values($entity);
                $station = array_values($station);
                $circuit = array_values($circuit);
            }
            $css = $this->cycle([
                "odd",
                "even"
            ])->next();
            // identité, scolarité : lignes 1 à 4
            $colonne1_4 = '<td %s' . $nbAffectations . '>' . $row['nom'] . '</td>';
            $colonne1_4 .= '<td %s' . $nbAffectations . '>' . $row['prenom'] . '</td>';
            $colonne1_4 .= '<td %s' . $nbAffectations . '>' . $row['etablissement'] .
                '</td>';
            $colonne1_4 .= '<td %s' . $nbAffectations . '>' . $row['communeEtablissement'] .
                '</td>';
            // on prépare le code HTML avant pour ajuster les "rowspan", les boutons
            // et les hiddens si nécessaire
            $boutons_ligne = [
                'modifier' => [
                    'class' => 'button ligne',
                    'formaction' => $url_edit,
                    'title' => 'modifier la scolarité de ' . $row['prenom'],
                    'value' => 'Modifier ou compléter'
                ],
                'supprimer' => [
                    'class' => 'button ligne',
                    'formaction' => $url_delete,
                    'title' => 'supprimer l\'incription de ' . $row['prenom'],
                    'value' => 'Supprimer'
                ],
                'horaires' => [
                    'class' => 'button ligne ' . $avant_fin_aout,
                    'formaction' => $url_horaires,
                    'value' => 'Horaires'
                ],
                'photo' => [
                    'class' => 'button ligne',
                    'formaction' => $url_envoi_photo,
                    'value' => 'Envoyer une photo'
                ]
            ];
            $nbCircuits = count($circuit);
            switch ($nbCircuits) {
                case 0:
                    $hiddens_ligne = [
                        'id' => $row['eleveId'],
                        'eleveId' => $row['eleveId']
                    ];
                    if ($row['hasphoto']) {
                        // pas d'affectation donc pas d'horaires, on peut modifier ou
                        // supprimer
                        unset($boutons_ligne['horaires'], $boutons_ligne['photo']);
                        $code_boutons = $this->listeLigneActions($row['eleveId'],
                            $hiddens_ligne, $boutons_ligne);
                    } else {
                        // bouton photo et pas d'horaires, on peut modifier ou supprimer
                        unset($boutons_ligne['horaires']);
                        $code_boutons = $this->listeLigneActions($row['eleveId'],
                            $hiddens_ligne, $boutons_ligne);
                    }
                    $colonne1_4 = str_replace(' %s' . $nbAffectations, '', $colonne1_4);
                    $ligneHtml = '<tr class="' . $css . '">' . $colonne1_4;
                    $ligneHtml .= '<td></td><td></td>'; // affectation
                    $ligneHtml .= "<td>$code_boutons</td><td class=\"alert\">$msgphoto</td></tr>\n";
                    break;
                case 1:
                    if (empty($circuit[0])) {
                        // il y a des points d'arrêt mais pas de circuit donc pas
                        // d'horaire, on peut modifier ou supprimer
                        $hiddens_ligne = [
                            'id' => $row['eleveId'],
                            'eleveId' => $row['eleveId']
                        ];
                        unset($boutons_ligne['horaires']);
                    } else {
                        $hiddens_ligne = [
                            'id' => $row['eleveId'],
                            'eleveId' => $row['eleveId'],
                            'circuit1Id' => $circuit[0],
                            'etablissementId' => $row['etablissementId']
                        ];
                    }
                    if ($row['hasphoto']) {
                        unset($boutons_ligne['photo']);
                        $code_boutons = $this->listeLigneActions($row['eleveId'],
                            $hiddens_ligne, $boutons_ligne);
                    } else {
                        // au moins le bouton photo
                        $hiddens_ligne['eleveId'] = $row['eleveId'];
                        $code_boutons = $this->listeLigneActions($row['eleveId'],
                            $hiddens_ligne, $boutons_ligne);
                    }
                    $colonne1_4 = str_replace(' %s' . $nbAffectations, '', $colonne1_4);
                    $ligneHtml = '<tr class="' . $css . '">' . $colonne1_4;
                    $ligneHtml .= sprintf(
                        '<td class="%1$s">' . $entity[0] . '</td><td class="%1$s">' .
                        $station[0] . '</td>', $avant_fin_aout);
                    $ligneHtml .= '<td>' . $code_boutons .
                        "</td><td class=\"alert\">$msgphoto</td></tr>\n";
                    break;
                default:
                    $rowspan = $avant_fin_aout ? 1 : $nbCircuits;
                    $colonne1_4 = str_replace('%s' . $nbAffectations,
                        'rowspan="' . $rowspan . '"', $colonne1_4);
                    $lignesTableau = [];
                    $hiddens_ligne = [
                        'enfant' => $row['prenom'] . ' ' . $row['nom'],
                        'id' => $row['eleveId'],
                        'eleveId' => $row['eleveId']
                    ];
                    for ($i = 0; $i < $nbCircuits; $i ++) {
                        if (! empty($circuit[$i])) {
                            $hiddens_ligne['circuit' . ($i + 1) . 'Id'] = $circuit[$i];
                        }
                        $lignesTableau[$i] = '<tr class="' . $css . '">' . $colonne1_4;
                        $lignesTableau[$i] .= sprintf(
                            '<td class="%1$s">' . $entity[$i] . '</td><td class="%1$s">' .
                            $station[$i] . '</td>', $avant_fin_aout);
                        // on ne termine pas la ligne 0 pour pouvoir rajouter le bouton et
                        // les hiddens
                        if ($i > 0) {
                            $lignesTableau[$i] .= "</tr>\n";
                        }
                        $colonne1_4 = '';
                    }
                    // pour terminer la ligne 0
                    if (empty($hiddens_ligne)) {
                        if ($row['hasphoto']) {
                            // pas de bouton
                            $lignesTableau[0] .= "<td></td><td class=\"alert\">$msgphoto</td></tr>\n";
                        } else {
                            // bouton `Envoyer une photo` et supprimer
                        }
                    } else {
                        $hiddens_ligne['etablissementId'] = $row['etablissementId'];
                        if ($row['hasphoto']) {
                            // bouton `Horaires` et suppression
                            unset($boutons_ligne['photo'], $boutons_ligne['modifier']);
                        } else {
                            // les boutons horaires, photo et suppression
                            unset($boutons_ligne['modifier']);
                        }
                    }
                    if (empty($hiddens_ligne) && $row['hasphoto']) {
                    } else {
                        $code_boutons = $this->listeLigneActions($row['eleveId'],
                            $hiddens_ligne, $boutons_ligne);
                        $lignesTableau[0] .= '<td rowspan="' . $rowspan . '">' .
                            $code_boutons .
                            "</td><td class=\"alert\"rowspan=\"$rowspan\">$msgphoto</td></tr>\n";
                    }
                    $ligneHtml = implode('', $lignesTableau);
                    break;
            }
            echo $ligneHtml;
        }
        ?>
            </tbody>
			</table>
		</fieldset>
<?php if ($photo_manquante): ?>
        <p class="important">OBLIGATOIRE : Veuillez transmettre une
			photo d'identité récente pour obtenir la carte de transport.</p>
<?php elseif (Session::get('as')['dateDebut'] >= date('Y-m-d')):?>
    <?php if ($nbInscrits > 1):?>
		<p class="sbm-description">Vous allez recevoir les cartes de transport
			par courrier courant août ou début septembre.</p>
    <?php else :?>
        <p class="sbm-description">Vous allez recevoir la carte de
			transport par courrier courant août ou début septembre.</p>
    <?php endif;?>
<?php endif;?>
<?php if (!empty($avant_fin_aout)):?>
		<p class="sbm-description">Les circuits et horaires seront
			consultables ici à partir de la dernière semaine d'août.</p>
<?php endif;?>
    <?php endif; // $nbInscrits > 0 ?>
    </div>
	<div id="parent-compte"><?php if ($etatDuSite['inscription']):?>
        <div class="bouton-inscrire">
			<div class="menu clearfix">
        <?php
        $boutons = [
            'inscrire' => [
                'class' => 'button default float-right left-10px',
                'formaction' => $url_ajoutEleve,
                'value' => 'Inscrire un autre enfant'
            ]
        ];
        if ($this->resultats->getSolde() > 0 && $this->responsable->paiementenligne) {
            $payerTitle = "Payer par carte bancaire.";
            $payerMsg = true;
            $boutons['payer'] = [
                'class' => 'button default float-right left-10px',
                'formaction' => $url_payer,
                'value' => 'Payer par CB',
                'title' => $payerTitle
            ];
        }
        $boutons['facture'] = [
            'class' => 'button default float-right left-10px',
            'formaction' => $url_facture,
            'formtarget' => '_blank',
            'value' => 'Imprimer la facture'
        ];
        echo $this->listeZoneActions(
            [
                'montant' => $this->resultats->getSolde(),
                'namespacectrl' => $this->namespacectrl
            ], $boutons);
        ?>
            </div>
		</div>
        <?php if (! $this->responsable->paiementenligne && $this->resultats->getSolde() > 0) : ?>
        <p class="sbm-description">Les habitants de votre commune ne
			peuvent pas payer en ligne. Prenez contact avec le service Transport
			pour connaitre la marche à suivre pour votre cas particulier.</p>
        <?php elseif ($this->resultats->getSolde() > 0) : ?>
        <?php
            switch ($etatDuSite['etat']) {
                case $this->calendar::ETAT_PENDANT:
                    $permanences = $this->calendar->getPermanences(
                        $this->responsable->commune);
                    switch (count($permanences)) {
                        case 0:
                            $permanences = '';
                            break;
                        case 1:
                            $permanences = current($permanences);
                            break;
                        default:
                            $permanences = implode(', ', $permanences);
                            break;
                    }
                    $msg = <<<EOT
                    EOT;
                    $msg = sprintf($msg, $adresse_organisateur, $permanences);
                    break;
                case $this->calendar::ETAT_APRES:
                    $permanences = $this->calendar->getPermanences(
                        $this->responsable->commune);
                    switch (count($permanences)) {
                        case 0:
                            $permanences = '';
                            break;
                        case 1:
                            $permanences = current($permanences);
                            break;
                        default:
                            $permanences = implode(', ', $permanences);
                            break;
                    }
                    $msg = <<<EOT
                    EOT;
                    $msg = sprintf($msg, $adresse_organisateur, $permanences);
                    break;
                default:
                    // ici les inscriptions sont ouvertes. Pas de ETAT_AVANT ou de
                    // ETAT_FERME
                    $msg = '';
                    break;
            }
            ?>
		<p class="sbm-description">
		    <?php if($payerMsg):?>
			<i id="help-preinscrits" title="Comment payer ?" class="fam-help"></i>
			Comment payer ?<br>
			<?php endif;?>
			<?=$msg;?>
		</p>
		<?php endif;?>
		<div id="help-preinscrits-content" class="invisible">
			<p>Vous pouvez :</p>
			<ul>
				<li style="margin-bottom: 0.4rem;">payer en ligne à l'aide d'une
					carte bancaire.</li>
				<li style="margin-bottom: 0.4rem;">adresser un chèque du montant
					indiqué à l'adresse ci-dessous.</li>
				<li>vous rendre à <?=$adresse_organisateur;?> pour payer en espèces ou par chèque.</li>
			</ul>
			<div class="centre">
				<?=$this->client['name'];?><br>
				<?=implode('<br>',$this->client['adresse']);?><br>
				<?=$this->client['code_postal']; ?> <?=$this->client['commune'];?><br>
				Tél. <?=$this->telephone($this->client['telephone']);?>
		    </div>
		</div>
	<?php elseif ($this->resultats->getSolde() > 0):?>
	<?php
        $url_contact = $this->url('login', [
            'action' => 'contact'
        ]);
        $msg = 'Les insciptions étant closes, <a href="%s">prenez contact avec le service de transport.</a>';
        $msg = sprintf($msg, $url_contact);
        ?>
	    <p class="sbm-description">
			<i class="fam-help"></i> <b>Comment payer ?</b> <?=$msg;?>
		</p>
    <?php endif;?>
    </div>
	<div id="wrapper-finance" class="clearfix">
		<div id="parent-paiements" class="float-left">
    	<?php if ($nbPaiements) : ?>
    		<fieldset class="sbm-page1">
				<legend>Paiements enregistrés</legend>
				<table class="parent paiement">
					<tbody>
						<tr>
							<th>Date du paiement</th>
							<th>Moyen de paiement</th>
							<th>Montant</th>
						</tr>
            <?php foreach ($this->paiements as $row) :?>
            			<tr>
							<td><?=DateLib::formatDateTimeFromMysql($row->datePaiement);?></td>
							<td><?=$row->modeDePaiement;?></td>
							<td class="align-right"><?=$fmt->formatCurrency($row->montant, 'EUR');?></td>
						</tr>
        	<?php endforeach;?>
            		</tbody>
				</table>
			</fieldset>
    	<?php endif; ?>
    	</div>
		<div id="parent-factures" class="float-left">
    	<?php if ($this->factures->count()) : ?>
    		<fieldset class="sbm-page1">
				<legend>Factures émises</legend>
				<table class="parent factures">
					<tbody>
						<tr>
							<th>Numéro</th>
							<th>Date</th>
							<th>Montant</th>
						</tr>
            <?php foreach ($this->factures as $row) :?>
            			<tr>
							<td><?=$row->numero;?></td>
							<td><?=DateLib::formatDateFromMysql($row->date);?></td>
							<td class="align-right"><?=$fmt->formatCurrency($row->montant, 'EUR');?></td>
						</tr>
        	<?php endforeach;?>
            		</tbody>
				</table>
			</fieldset>
    	<?php endif; ?>
    	</div>
	</div>
</div>
<?php endif;?>