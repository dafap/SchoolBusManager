<?php
/**
 * Page d'entrée dans l'espace Parents - Version Arlysère
 *
 * Elle dispose des propriétés suivantes :
 * 'theme' : objet SbmInstallation\Model\Theme
 * 'namespacectrl' : controle du namespace
 * 'responsable' : objet responsable créé lors du login
 * 'calendar' : objet SbmCommun\Model\Db\Service\Table\System\Calendar
 * 'inscrits' : résultat de la requête Sbm\Db\Query\ElevesScolarites::getElevesInscrits()
 * 'preinscrits' => résultat de la requête Sbm\Db\Query\ElevesScolarites::getElevesPreinscritsOuEnAttente()
 * 'affectations' => résultat de la requête Sbm\Db\Query\AffectationsServicesStations
 * 'resultats' => objet SbmCommun\Model\Paiement\resultats présentant les justificatifs des sommes dues
 * 'paiements' => ensemble des paiements enregistrés pour ce parent durant cette année scolaire
 * 'factures' => ensemble des factures enregistrées pour ce parent durant cette année scolaire
 * 'client' : tableau décrivant l'organisateur (array)
 * 'accueil' : url du site de l'organisateur
 * 'adresse' : tableau de l'adresse du parent
 *
 * @project sbm
 * @package SbmParent/view/sbm-parent/index
 * @filesource index.phtml
 * @encodage UTF-8
 * @author DAFAP Informatique - Alain Pomirol (dafap@free.fr)
 * @date 28 avr. 2020
 * @version 2020-2.6.0
 */
use SbmBase\Model\DateLib;
use SbmBase\Model\Session;
use SbmCommun\Model\Paiements\GrilleTarifInterface;

// Nomenclature
$rendez_vous = 'POINT INFO BUS';
// ================================================================================
$this->headLink()->appendStylesheet($this->basePath('/css/fam-icons-custom.css'));
$this->themeCss('sbm-parent/index', 'index.css');
$this->jQuery('jquery-ui');
$this->themeJS('sbm-parent', 'index.js');
$fmt = new NumberFormatter('fr_FR', NumberFormatter::CURRENCY);
// affichage des circuits, stations et horaires
$avant_fin_aout = '';
if ((new \DateTime()) <
    (new \DateTime(Session::get('as')['dateDebut']))->modify('8 days ago')) {
    $avant_fin_aout = 'invisible';
}
// initialisation nécessaire pour le popup help-preinscrits-content :
$permanences = '';
$enAttente = false;
$adresse_organisateur = implode(', ',
    [
        $this->client['name'],
        implode(', ', $this->client['adresse']),
        sprintf('%s %s', $this->client['code_postal'], $this->client['commune'])
    ]);
$nbPreinscrits = $this->preinscrits->count();
$nbInscrits = $this->inscrits->count();
$nbPaiements = $this->paiements->count();
$etatDuSite = $this->calendar->getEtatDuSite();
// pour sadmin, autoriser les inscriptions et le paiement
if ($this->sadmin) {
    $etatDuSite['etat'] = $this->calendar::ETAT_PENDANT;
    $etatDuSite['inscription'] = true;
}
$dateFinReduction = $etatDuSite['echeance']->format('d/m/Y');
$url_ajoutEleve = $this->url('sbmparent', [
    'action' => 'reinscription-eleve'
]);
$url_payercb1 = $this->url('sbmpaiement', [
    'action' => 'formulaire'
]);
$url_payercb3 = $this->url('sbmpaiement', [
    'action' => 'formulaire',
    'id' => 3
]);
$url_horaires = $this->url('sbmparent', [
    'action' => 'horaires'
]);
$url_envoi_photo = $this->url('sbmparent', [
    'action' => 'envoiphoto'
]);
$url_edit = $this->url('sbmparent', [
    'action' => 'edit-eleve'
]);
$url_delete = $this->url('sbmparent', [
    'action' => 'suppr-eleve'
]);
$url_attente = $this->url('sbmparent', [
    'action' => 'attente-eleve'
]);
$url_facture = $this->url('sbmdocument', [
    'action' => 'facture'
]);
?>
<div id="winpopup">
	<div id="winpopup-content"
		style="margin-left: 30px; margin-right: 30px;"></div>
</div>
<div class="clearfix">
	<h1>Espace Parents</h1>
	<div class="flashMessenger float-right">
<?=$this->flashMessenger()->render('success');?>
<?=$this->flashMessenger()->render('warning');?>
<?=$this->flashMessenger()->render('error');?>
<?=$this->flashMessenger()->render('info');?>
<?=$this->flashMessenger()->render('default');?>
	</div>
</div>
<?php if ($nbInscrits == 0 && $nbPreinscrits == 0) : ?>
<div id="parent-wrapper" class="explication">
	<?php
    switch ($etatDuSite['etat']) {
        case $this->calendar::ETAT_AVANT:
            echo include $this->theme->getIncludeView('sbm-parent/index/index-avant');
            break;
        case $this->calendar::ETAT_PENDANT:
            echo include $this->theme->getIncludeView('sbm-parent/index/index-pendant');
            break;
        case $this->calendar::ETAT_APRES:
            echo include $this->theme->getIncludeView('sbm-parent/index/index-apres');
            break;
        default:
            echo include $this->theme->getIncludeView('sbm-parent/index/index-ferme');
            break;
    }
    ?>
</div>
<?php else : ?>
<?php
    $votre_vos = $nbPreinscrits == 1 ? 'votre' : 'vos';
    $sera_seront = $nbPreinscrits == 1 ? 'sera' : 'seront';
    $date_horaires_cartes = (new \DateTime(Session::get('as')['dateDebut']))->modify(
        '8 days ago')->format('d/m/Y');
    switch ($etatDuSite['etat']) {
        case $this->calendar::ETAT_PENDANT:
            $msg_reception_pass_inscrit = <<<EOT
            Vous recevrez $votre_vos PASS ANNUEL JUNIOR par voie postale &agrave;
            l'adresse indiqu&eacute;e &agrave; partir du $date_horaires_cartes.
            EOT;
            $msg_reception_pass_preinscrit = <<<EOT
            Le PASS ANNUEL JUNIOR ne sera d&eacute;livr&eacute; que si vous avez transmis une photo 
            d'identit&eacute; de l'&eacute;l&egrave;ve et <span id="help-payer" class="orange" 
            title="Comment payer ?">pay&eacute; son abonnement <em class="fam-help"> </em></span><br>
            L'inscription doit &ecirc;tre r&eacute;gl&eacute;e avant le %s pour obtenir une place 
            d&eacute;finitive sur le circuit et recevoir le PASS MOBILIT&Eacute; JUNIOR par la poste 
            &agrave; partir du $date_horaires_cartes.
            EOT;
            $msg_reception_pass_preinscrit = sprintf($msg_reception_pass_preinscrit,
                $dateFinReduction);
            $msg_circuit_horaire = <<<EOT
            Les circuits et horaires seront consultables ici &agrave; partir du $date_horaires_cartes.
            EOT;
            break;
        case $this->calendar::ETAT_APRES:
            $votre_vos = ucfirst($votre_vos);
            $msg_reception_pass_inscrit = <<<EOT
            $votre_vos PASS ANNUEL JUNIOR $sera_seront &agrave; retirer au Point Info Bus apr&egrave;s
            r&eacute;ception d'un mail de confirmation vous pr&eacute;cisant la disponibilit&eacute;.
            EOT;
            $msg_reception_pass_preinscrit = <<<EOT
            Le PASS ANNUEL JUNIOR ne sera d&eacute;livr&eacute; que si vous avez transmis une photo 
            d'identit&eacute; de l'&eacute;l&egrave;ve et <span id="help-payer" class="orange" 
            title="Comment payer ?">pay&eacute; son abonnement <em class="fam-help"> </em></span><br>
            Vous pourrez le retirer au Point Info Bus apr&egrave;s
            r&eacute;ception d'un mail de confirmation vous pr&eacute;cisant la disponibilit&eacute;.
            EOT;
            $msg_circuit_horaire = "Les circuits et horaires seront consultables ici ";
            if ((new DateTime()) <(new \DateTime(Session::get('as')['dateDebut']))->modify(
                '8 days ago')) {
                $msg_circuit_horaire .= "&agrave; partir du $date_horaires_cartes et ";
            }
            $msg_circuit_horaire .= 'apr&egrave;s traitement de votre demande.';
            break;
        default:
            $msg_reception_pass_inscrit = '';
            $msg_reception_pass_preinscrit='';
            $msg_circuit_horaire='';
            break;
    }
    $msg_photo_manquante = <<<EOT
    Veuillez transmettre une photo d'identit&eacute; r&eacute;cente pour obtenir la carte de transport.
    EOT;
    ?>
<div id="parent-wrapper">
	<div id="parent-inscrits">
    <?php if ($nbInscrits) : ?>
    <fieldset class="sbm-page1">
			<legend>Enfants inscrits</legend>
			<table class="parent eleve">
				<tbody>
					<tr class="petit">
						<th>Nom</th>
						<th>Pr&eacute;nom</th>
						<th>&Eacute;tablissement scolaire</th>
						<th>Commune</th>
						<th>Tarif</th>
						<th class="<?=$avant_fin_aout;?>">Circuit</th>
						<th class="<?=$avant_fin_aout;?>">Arr&ecirc;t</th>
						<th></th>
					</tr>
<?php
        $photo_manquante = false;
        foreach ($this->inscrits as $row) {
            $hiddens_ligne = [];
            $photo_manquante |= ! $row['hasphoto'];
            $reseau = $this->affectations->getCorrespondances($row['eleveId']);
            $nbAffectations = $reseau->count();
            $circuit = $station = $entity = [];
            $msgphoto = $row['hasphoto'] ? '' : 'Pas de photo';
            if ($nbAffectations) {
                // construction des tableaux $entity, $station et $circuit sans doublons
                foreach ($reseau as $transport) {
                    $service_transporteur = $transport['service1'] . ' - ' .
                        $transport['transporteur1'];
                    $station_commune = $transport['station1'] . ' - ' .
                        $transport['commune1'];
                    $circuitId = $transport['circuit1Id'];
                    $key = md5(
                        sprintf('%s;%s;%d', $service_transporteur, $station_commune,
                            $circuitId));
                    $entity[$key] = $service_transporteur;
                    $station[$key] = $station_commune;
                    $circuit[$key] = $circuitId;
                    $correspondance = ! empty($transport['ligne2Id']) ||
                        ! empty($transport['station2Id']);
                    if ($correspondance) {
                        if (! empty($transport['ligne2Id'])) {
                            $service_transporteur = $transport['service2'] . ' - ' .
                                $transport['transporteur2'];
                        } else {
                            $service_transporteur = '';
                        }
                        if (! empty($transport['station2Id'])) {
                            $station_commune = $transport['station2'] . ' - ' .
                                $transport['commune2'];
                        } else {
                            $station_commune = '';
                        }
                        if (! empty($transport['circuit2Id'])) {
                            $circuitId = $transport['circuit2Id'];
                        } else {
                            $circuitId = 0;
                        }
                        $key = md5(
                            sprintf('%s;%s;%d', $service_transporteur, $station_commune,
                                $circuitId));
                        $entity[$key] = $service_transporteur;
                        $station[$key] = $station_commune;
                        $circuit[$key] = $circuitId;
                    }
                }
                $entity = array_values($entity);
                $station = array_values($station);
                $circuit = array_values($circuit);
            }
            $css = $this->cycle([
                "odd",
                "even"
            ])->next();
            // identité, scolarité : lignes 1 à 4
            $colonne1_5 = '<td %s' . $nbAffectations . '>' . $row['nom'] . '</td>';
            $colonne1_5 .= '<td %s' . $nbAffectations . '>' . $row['prenom'] . '</td>';
            $colonne1_5 .= '<td %s' . $nbAffectations . '>' . $row['etablissement'] .
                '</td>';
            $colonne1_5 .= '<td %s' . $nbAffectations . '>' . $row['communeEtablissement'] .
                '</td>';
            $colonne1_5 .= '<td %s' . $nbAffectations . '>' .
                sprintf('%s %s', $row['grilleTarifR1'],
                    $row['reductionR1'] ? 'R&eacute;duit' : 'Normal') . '</td>';
            // on prépare le code HTML avant pour ajuster les "rowspan", les boutons
            // et les hiddens si nécessaire
            $boutons_ligne = [
                'horaires' => [
                    'class' => 'button ligne',
                    'formaction' => $url_horaires,
                    'value' => 'Horaires'
                ],
                'photo' => [
                    'class' => 'button ligne',
                    'formaction' => $url_envoi_photo,
                    'value' => 'Envoyer une photo'
                ]
            ];
            if ($avant_fin_aout) {
                unset($boutons_ligne['horaires']);
            }
            $nbCircuits = count($circuit);
            switch ($nbCircuits) {
                case 0:
                    if ($row['hasphoto']) {
                        // pas de bouton, pas d'affectation donc pas d'horaire
                        $code_boutons = '';
                    } else {
                        // bouton photo et pas d'horaire
                        unset($boutons_ligne['horaires']);
                        $hiddens_ligne['eleveId'] = $row['eleveId'];
                        $code_boutons = $this->listeLigneActions($row['eleveId'],
                            $hiddens_ligne, $boutons_ligne);
                    }
                    $colonne1_5 = str_replace(' %s' . $nbAffectations, '', $colonne1_5);
                    $ligneHtml = '<tr class="petit ' . $css . '">' . $colonne1_5;
                    $ligneHtml .= sprintf('<td class="%1$s"></td><td class="%1$s"></td>',
                        $avant_fin_aout); // affectation
                    $ligneHtml .= "<td>$code_boutons</td><td class=\"alert\">$msgphoto</td></tr>\n";
                    break;
                case 1:
                    if (empty($circuit[0])) {
                        // il y a des points d'arrêt mais pas de circuit donc pas
                        // d'horaire
                        unset($boutons_ligne['horaires']);
                    } else {
                        $hiddens_ligne = [
                            'circuit1Id' => $circuit[0],
                            'etablissementId' => $row['etablissementId']
                        ];
                    }
                    if ($row['hasphoto']) {
                        unset($boutons_ligne['photo']);
                        if (empty($circuit[0])) {
                            $code_boutons = '';
                        } else {
                            // bouton horaires
                            $code_boutons = $this->listeLigneActions($row['eleveId'],
                                $hiddens_ligne, $boutons_ligne);
                        }
                    } else {
                        // au moins le bouton photo
                        $hiddens_ligne['eleveId'] = $row['eleveId'];
                        $code_boutons = $this->listeLigneActions($row['eleveId'],
                            $hiddens_ligne, $boutons_ligne);
                    }
                    $colonne1_5 = str_replace(' %s' . $nbAffectations, '', $colonne1_5);
                    $ligneHtml = '<tr class="' . $css . '">' . $colonne1_5; // identité,
                                                                            // scolarité
                    $ligneHtml .= '<td class="' . $avant_fin_aout . '">' . $entity[0] .
                        '</td><td class="' . $avant_fin_aout . '">' . $station[0] . '</td>';
                    $ligneHtml .= '<td>' . $code_boutons .
                        "</td><td class=\"alert\">$msgphoto</td></tr>\n";
                    break;
                default:
                    $colonne1_5 = str_replace('%s' . $nbAffectations,
                        'rowspan="' . $nbCircuits . '"', $colonne1_5);
                    $lignesTableau = [];
                    $hiddens_ligne = [
                        'enfant' => $row['prenom'] . ' ' . $row['nom']
                    ];
                    for ($i = 0; $i < $nbCircuits; $i ++) {
                        if (! empty($circuit[$i])) {
                            $hiddens_ligne['circuit' . ($i + 1) . 'Id'] = $circuit[$i];
                        }
                        $lignesTableau[$i] = '<tr class="petit ' . $css . '">' .
                            $colonne1_5;
                        $lignesTableau[$i] .= '<td class="' . $avant_fin_aout . '">' .
                            $entity[$i] . '</td><td class="' . $avant_fin_aout . '">' .
                            $station[$i] . '</td>';
                        // on ne termine pas la ligne 0 pour pouvoir rajouter le bouton et
                        // les hiddens
                        if ($i > 0) {
                            $lignesTableau[$i] .= "</tr>\n";
                        }
                        $colonne1_5 = '';
                    }
                    // pour terminer la ligne 0
                    if (empty($hiddens_ligne)) {
                        if ($row['hasphoto']) {
                            // pas de bouton
                            $lignesTableau[0] .= "<td></td><td class=\"alert\">$msgphoto</td></tr>\n";
                        } else {
                            // bouton `Envoyer une photo`
                            $hiddens_ligne['eleveId'] = $row['eleveId'];
                        }
                    } else {
                        $hiddens_ligne['etablissementId'] = $row['etablissementId'];
                        if ($row['hasphoto']) {
                            // bouton `Horaires`
                            unset($boutons_ligne['photo']);
                        } else {
                            // les 2 boutons
                            $hiddens_ligne['eleveId'] = $row['eleveId'];
                        }
                    }
                    if (empty($hiddens_ligne) && $row['hasphoto']) {
                    } else {
                        $code_boutons = $this->listeLigneActions($row['eleveId'],
                            $hiddens_ligne, $boutons_ligne);
                        $lignesTableau[0] .= '<td rowspan="' . $nbCircuits . '">' .
                            $code_boutons .
                            "</td><td class=\"alert\"rowspan=\"$nbCircuits\">$msgphoto</td></tr>\n";
                    }
                    $ligneHtml = implode('', $lignesTableau);
                    break;
            }
            echo $ligneHtml;
        }
        ?>
</tbody>
			</table>
		</fieldset>
<?php if ($photo_manquante): ?>
<p class="important"><?=$msg_photo_manquante;?></p>
<?php elseif (Session::get('as')['dateDebut'] >= date('Y-m-d')):?>
<p class="sbm-description"><?=$msg_reception_pass_inscrit;?></p>
<?php endif;?>
<p class="sbm-description"><?=$msg_circuit_horaire;?></p>
<?php endif; ?>
</div>
	<div id="parent-preinscrits">
    <?php if ($nbPreinscrits) : ?>
    <fieldset class="sbm-page1">
			<legend>Enfants pr&eacute;inscrits</legend>
			<table class="parent eleve">
				<tbody>
					<tr class="petit">
						<th>Nom</th>
						<th>Pr&eacute;nom</th>
						<th>&Eacute;tablissement scolaire</th>
						<th>Commune</th>
						<th>Tarif</th>
					</tr>
            <?php
        $alerte = false;
        foreach ($this->preinscrits as $row) {
            $peutPayer = true;
            if ($row['selectionScolarite']) {
                $grilleTarif = '<span class="exces" title="Cet enfant n\'est pas inscrit.' .
                    ' Respectez les d&eacute;lais.">en attente</span>';
                $enAttente = true;
            } elseif ($peutPayer) {
                $grilleTarif = sprintf('%s %s', $row['grilleTarifR1'],
                    $row['reductionR1'] ? 'R&eacute;duit' : 'Normal');
            } else {
                $msgalerte = 'Pour obtenir une &eacute;ventuelle d&eacute;rogation, prenez contact avec le service des transports de : ';
                $msgalerte .= $this->client['name'];
                $grilleTarif = '<span class="exces" title="' . $msgalerte . '">' .
                    $row['grilleTarifR1'] . '</span>';
                $msgalerte .= ' (' . $this->telephone($this->client['telephone']) . ') ou ';
                $msgalerte .= '<a href="' .
                    $this->url('sbmparentconfig', [
                        'action' => 'message'
                    ]) . '">&Eacute;crire</a>';
                $alerte = true;
            }
            $hiddens = [
                'id' => $row['eleveId']
            ];
            if ($etatDuSite['inscription']) {
                $buttons = [
                    'modifier' => [
                        'class' => 'button ligne',
                        'formaction' => $url_edit,
                        'title' => 'modifier la scolarit&eacute; de ' . $row['prenom'],
                        'value' => 'Modifier ou compl&eacute;ter'
                    ],
                    'supprimer' => [
                        'class' => 'button ligne',
                        'formaction' => $url_delete,
                        'title' => 'supprimer l\'incription de ' . $row['prenom'],
                        'value' => 'Supprimer'
                    ]
                ];
                if ($this->responsable->paiementenligne) {
                    $attenteValue = $row['selectionScolarite'] ? 'Reprendre cet enfant' : 'Mettre en attente de paiement';
                    $attenteTitle = $row['selectionScolarite'] ? 'Remettre ' .
                        $row['prenom'] . ' dans' : 'Retirer ' . $row['prenom'] . ' de';
                    $attenteTitle .= ' la liste des inscriptions &agrave; payer';
                    $buttons['attente'] = [
                        'class' => 'button ligne',
                        'formaction' => $url_attente,
                        'title' => $attenteTitle,
                        'value' => $attenteValue
                    ];
                }
            } else {
                $buttons = [];
            }
            if ($row['hasphoto']) {
                $pasdephoto = '';
            } else {
                $hiddens['eleveId'] = $row['eleveId'];
                $buttons['photo'] = [
                    'class' => 'button ligne',
                    'formaction' => $url_envoi_photo,
                    'value' => 'Envoyer une photo'
                ];
                $pasdephoto = ' Pas de photo';
            }
            $btligne = $this->listeLigneActions($row['eleveId'], $hiddens, $buttons);
            $modeleligne = <<< EOT
            <tr class="petit %s">
                <td>%s</td>
                <td>%s</td>
                <td>%s</td>
                <td>%s</td>
                <td>%s</td>
                <td>%s</td>
                <td class="alert">%s</td>
            </tr>
            EOT;
            echo sprintf($modeleligne, $this->cycle([
                "odd",
                "even"
            ])->next(), $row['nom'], $row['prenom'], $row['etablissement'],
                $row['communeEtablissement'], $grilleTarif, $btligne, $pasdephoto);
        }
        if ($alerte) {
            echo sprintf('<tr class="petit alert"><td colspan="7">%s</td></tr>',
                $msgalerte);
        }
        ?>
            </tbody>
				<tfoot>
					<tr>
						<th colspan="4">Total &agrave; payer</th>
						<td class="align-right">
							<?=$fmt->formatCurrency($this->resultats->getMontantTotal(), 'EUR');?>
							</td>
					</tr>
					<tr>
						<th colspan="4">D&eacute;j&agrave; pay&eacute;</th>
						<td class="align-right">
							<?=$fmt->formatCurrency($this->resultats->getPaiementsMontant(), 'EUR');?>
							</td>
					</tr>
					<tr>
						<th colspan="4">Solde</th>
						<th class="align-right">
							<?=$fmt->formatCurrency($this->resultats->getSolde(), 'EUR');?>
							</th>
					</tr>
				</tfoot>
			</table>
		</fieldset>
    <?php endif; ?>
    <?php if ($etatDuSite['inscription']):?>
        <div class="bouton-inscrire">
			<div class="menu clearfix">
        <?php
        $boutons = [
            'inscrire' => [
                'class' => 'button default float-right left-10px',
                'formaction' => $url_ajoutEleve,
                'value' => 'Inscrire un autre enfant'
            ]
        ];
        if ($this->resultats->getSolde() > 0 && $this->responsable->paiementenligne) {
            if ($enAttente) {
                $payerTitle = "valider et payer toutes les incriptions\nqui ne sont pas en attente.";
            } else {
                $payerTitle = "valider et payer toutes les inscriptions\nde la liste des enfants pr&eacute;inscrits.";
            }
            $boutons['payer'] = [
                'class' => 'button default float-right left-10px',
                'value' => 'Valider la liste et payer',
                'title' => $payerTitle
            ];
            // ============== inclure ici le dialog ===================
            ?>
            <div id="payercb" class="invisible">
            <?php
            $montant_total = $this->resultats->getSolde();
            $montant_abonnement = round($montant_total * 100 / 3, 0) / 100;
            $montant_premier = $montant_total - 2 * $montant_abonnement;
            ?>
			<h3>Paiement par carte bancaire :</h3>
					<p>Vous pouvez :</p>
					<ul>
						<li>Payer la somme de <?=$fmt->formatCurrency($montant_total,'EUR');?>
						par carte bancaire</li>
						<li style="list-style: none;">ou</li>
						<li>Payer la somme de <?=$fmt->formatCurrency($montant_premier, 'EUR')?>
						aujourd'hui puis la somme de <?=$fmt->formatCurrency($montant_abonnement,'EUR');?>
						vous sera retir&eacute;e le <?= DateLib::datePlus1Mois()?> et &agrave; nouveau le
						<?=DateLib::datePlus2Mois() ?></li>
					</ul>
					<p>Votre choix ?</p>
					<div>
						<form method="POST">
							<input type="hidden" name="montant"
								value="<?=$this->resultats->getSolde()?>"> <input type="hidden"
								name="namespacectrl" value="<?=$this->namespacectrl;?>"> <input
								type="submit" name="btnpayercb1" id="btnpayercb1"
								class="default" formaction="<?=$url_payercb1;?>"
								style="margin-left: 50px;" title="Payer en 1 fois"
								value="Payer la totalit&eacute;"
								onclick='$("#winpopup").dialog("close");'> <input type="submit"
								name="btnpayercb3" id="btnpayercb3" class="default"
								formaction="<?=$url_payercb3;?>" style="margin-left: 50px;"
								title="Payer en 3 fois" value="Payer en 3 fois"
								onclick='$("#winpopup").dialog("close");'>
						</form>
					</div>
				</div>
		<?php
        }
        $boutons['facture'] = [
            'class' => 'button default float-right left-10px',
            'formaction' => $url_facture,
            'formtarget' => '_blank',
            'value' => 'Imprimer la facture'
        ];
        echo $this->listeZoneActions(
            [
                'montant' => $this->resultats->getSolde(),
                'namespacectrl' => $this->namespacectrl
            ], $boutons);
        ?>
            </div>
		</div>
        <?php if (! $this->responsable->paiementenligne && $this->resultats->getSolde() > 0) : ?>
        <p class="sbm-description">Les habitants de votre commune ne
			peuvent pas payer en ligne. Prenez contact avec le service Transport
			pour connaitre la marche &agrave; suivre pour votre cas particulier.</p>
        <?php elseif ($this->resultats->getSolde() > 0) : ?>
		<div id="content-payer" class="invisible">
			<p>Paiement de l'abonnement</p>
			<ul>
				<li><strong>Par carte bleue <span class="orange">*</span></strong>
					uniquement sur le site internet au moment de l'inscription.</li>
				<li><strong>Par ch&egrave;que <span class="orange">**</span></strong>
					&agrave; libeller &agrave; <strong>TRANSDEV ALBERTVILLE</strong>.</li>
				<li><strong>En esp&egrave;ces,</strong> au POINT INFO BUS, Place de
					la Gare &agrave; Albertville durant les heures d'ouverture.</li>
			</ul>
			<div style="display: table;">
				<div style="display: table-row; margin-top: 4px;">
					<div style="display: table-cell">
						<span class="orange">*</span>
					</div>
					<div style="display: table-cell">Facilit&eacute; de paiement en 3
						fois</div>
				</div>
				<div style="display: table-row; margin-top: 4px;">
					<div style="display: table-cell">
						<span class="orange">**</span>
					</div>
					<div style="display: table-cell">
						Facilit&eacute; de paiement en 3 fois : contacter le POINT INFO
						BUS<br>IMPORTANT : mentionner au dos du ch&egrave;que :
						<ul>
							<li>le nom du responsable l&eacute;gal</li>
							<li>le nom de l'&eacute;l&egrave;ve</li>
						</ul>
					</div>
				</div>
			</div>
			<p class="cursor-zoom-out orange retour">
				<em class="fam-cancel">&nbsp;</em> Cacher
			</p>
		</div>
		<p class="sbm-description">
			<?=$msg_reception_pass_preinscrit;?>
		</p>
		<?php endif;?>
	<?php elseif ($this->resultats->getSolde() > 0):?>
	<?php
        $url_contact = $this->url('login', [
            'action' => 'contact'
        ]);
        $msg = 'Les insciptions &eacute;tant closes, prenez contact avec le <a href="%s">%s</a>.';
        $msg = sprintf($msg, $url_contact, $rendez_vous);
        ?>
	    <p class="sbm-description">
			<?=$msg;?>
		</p>
    <?php endif;?>
	</div> <?php // fin de preinscrits ?>
	<div id="wrapper-finance" class="clearfix">
		<div id="parent-paiements" class="float-left">
    	<?php if ($nbPaiements) : ?>
    		<fieldset class="sbm-page1">
				<legend>Paiements enregistr&eacute;s</legend>
				<table class="parent paiement">
					<tbody>
						<tr class="petit">
							<th>Date du paiement</th>
							<th>Date de valeur</th>
							<th>Moyen de paiement</th>
							<th>Montant</th>
						</tr>
            <?php foreach ($this->paiements as $row) :?>
            			<tr class="petit">
							<td><?=DateLib::formatDateTimeFromMysql($row->datePaiement);?></td>
							<td><?=DateLib::formatDateTimeFromMysql($row->dateValeur);?></td>
							<td><?=$row->modeDePaiement;?></td>
							<td class="align-right"><?=$fmt->formatCurrency($row->montant, 'EUR');?></td>
						</tr>
        	<?php endforeach;?>
            		</tbody>
				</table>
			</fieldset>
    	<?php endif; ?>
    	</div>
		<div id="parent-factures" class="float-left">
    	<?php if ($this->factures->count()) : ?>
    		<fieldset class="sbm-page1">
				<legend>Factures &eacute;mises</legend>
				<table class="parent factures">
					<tbody>
						<tr class="petit">
							<th>Num&eacute;ro</th>
							<th>Date</th>
							<th>Montant</th>
						</tr>
            <?php foreach ($this->factures as $row) :?>
            			<tr class="petit">
							<td><?=$row->numero;?></td>
							<td><?=DateLib::formatDateFromMysql($row->date);?></td>
							<td class="align-right"><?=$fmt->formatCurrency($row->montant, 'EUR');?></td>
						</tr>
        	<?php endforeach;?>
            		</tbody>
				</table>
			</fieldset>
    	<?php endif; ?>
    	</div>
	</div>
</div>
<?php endif; ?>