<?php
/**
 * Page d'entrée dans l'espace Parents
 * 
 * @project sbm
 * @package SbmParent/view/sbm-parent/index
 * @filesource index.phtml
 * @encodage UTF-8
 * @author DAFAP Informatique - Alain Pomirol (dafap@free.fr)
 * @date 13 févr. 2015
 * @version 2015-1
 */
use SbmCommun\Model\DateLib;
$this->headLink()->appendStylesheet($this->basePath('/css/fam-icons-custom.css'));

$montantTotal = 0;
$fmt = new NumberFormatter('fr_FR', NumberFormatter::CURRENCY);
$enAttente = false;

$nbPreinscrits = $this->preinscrits->count();
$nbInscrits = $this->inscrits->count();
$nbPaiements = $this->paiements->count();
$dateLimite = date('d/m/Y', strtotime('+15 days'));

$url_ajoutEleve = $this->url('sbmparent', array(
    'action' => 'inscription-eleve'
));
$url_payer = $this->url('sbmpaiement', array(
    'action' => 'formulaire'
));
?>
<div class="flashMessenger float-right">
<?php
echo $this->flashMessenger()->render('success');
echo $this->flashMessenger()->render('warning');
echo $this->flashMessenger()->render('error');
echo $this->flashMessenger()->render('info');
echo $this->flashMessenger()->render('default');
?>
</div>
<h1>Espace parent</h1>
<?php if ($nbInscrits == 0 && $nbPreinscrits == 0) : ?>
<div class="explication">
	<p>Vous n'avez pas d'enfant inscrit.</p>
	<p>Inscrivez tous vos enfants qui doivent utiliser le service de transports scolaires puis effectuez 
globalement le paiement en ligne ou adressez votre paiment au service transport de la Communauté de 
Commune du Bassin Decazeville Aubin avant le <?php echo $dateLimite; ?>.</p>
	<p>
		<b>Les inscriptions ne seront prises en compte qu'une fois le paiement
			enregistré.</b> Vous pouvez donc préinscrire vos enfants, mais vous
		devez respecter la date limite de paiement sinon leurs préinscriptions
		seront supprimées et leurs places ne seront plus réservées.
	</p>
	<p>Un enfant ne peut être inscrit ou préinscrit que dans un seul
		établissement scolaire.</p>
	<p>
		Cliquez sur le bouton <b><i>Inscrire un enfant</i></b> pour commencer
		les inscriptions.
	</p>
<?php
    
    echo $this->listeZoneActions(array(), array(
        'inscrire' => array(
            'class' => 'button default',
            'formaction' => $url_ajoutEleve,
            'value' => 'Inscrire un enfant'
        )
    ));
    ?>
</div>
<?php else : ?>
<div id="parent-wrapper">
	<div id="parent-inscrits">
    <?php if ($nbInscrits) : ?>
    <fieldset class="sbm-page1">
			<legend>Enfants inscrits</legend>
			<table class="parent eleve">
				<tbody>
					<tr>
						<th>Nom</th>
						<th>Prénom</th>
						<th>Etablissement scolaire</th>
						<th>Commune</th>
						<th>Circuit</th>
						<th>Arrêt</th>
					</tr>
            <?php
        foreach ($this->inscrits as $row) {
            echo '<tr class="' . $this->cycle(array(
                "odd",
                "even"
            ))->next() . '"><td>' . $row['nom'] . '</td><td>' . $row['prenom'] . '</td><td>' . $row['etablissement'] . '</td><td>' . $row['communeEtablissement'] . '</td>';
            $reseau = $this->affectations->getCorrespondances($row['eleveId']);
            $station = $circuit = array();
            if ($reseau->count()) {
                foreach ($reseau as $transport) {
                    $circuit[] = $transport['service1Id'] . ' - ' . $transport['transporteur1'];
                    $station[] = $transport['station1'] . ' - ' . $transport['commune1'];
                    if (! empty($transport['service2Id'])) {
                        $circuit[] = $transport['service2Id'] . ' - ' . $transport['transporteur2'];
                    }
                    if (! empty($transport['station2Id'])) {
                        $circuit[] = $transport['station2'] . ' - ' . $transport['commune2'];
                    }
                }
            }
            echo '<td>' . implode('<br />', $circuit) . '</td><td>' . implode('<br />', $station) . '</td>';
            // echo '<td></td><td></td>';
            
            echo '</tr>';
        }
        ?>
            </tbody>
			</table>
		</fieldset>
    <?php endif; ?>
    </div>
	<div id="parent-preinscrits">
    <?php if ($nbPreinscrits) : ?>
    <fieldset class="sbm-page1">
			<legend>Enfants préinscrits</legend>
			<table class="parent eleve">
				<tbody>
					<tr>
						<th>Nom</th>
						<th>Prénom</th>
						<th>Etablissement scolaire</th>
						<th>Commune</th>
						<th>Tarif</th>
					</tr>
            <?php
        foreach ($this->preinscrits as $row) {
            $peutPayer = max($row['distanceR1'], $row['distanceR2']) >= 1.0 && ($row['district'] == 1 || $row['derogation'] == 1);
            if ($row['selectionScolarite']) {
                $montantUnitaire = 'en attente';
                $enAttente = true;
            } elseif ($peutPayer) {
                $montantUnitaire = $fmt->formatCurrency($this->montant, 'EUR');
                $montantTotal += $this->montant;
            } else {
                $montantUnitaire = '<span class="exces" title="Prenez contact avec le service des transports à la CCDA">pas de droit au transport scolaire</span>';
                $enAttente = true;
            }
            $url_edit = $this->url('sbmparent', array(
                'action' => 'edit-eleve'
            ));
            $url_delete = $this->url('sbmparent', array(
                'action' => 'suppr-eleve'
            ));
            $url_attente = $this->url('sbmparent', array(
                'action' => 'attente-eleve'
            ));
            $hiddens = array(
                'id' => $row['eleveId']
            );
            $buttons = array(
                'modifier' => array(
                    'class' => 'button default left-10px',
                    'formaction' => $url_edit,
                    'title' => 'modifier la scolarité de ' . $row['prenom'],
                    'value' => 'Modifier'
                ),
                'supprimer' => array(
                    'class' => 'button default left-10px',
                    'formaction' => $url_delete,
                    'title' => 'supprimer l\'incription de ' . $row['prenom'],
                    'value' => 'Supprimer'
                )
            );
            if ($peutPayer) {
                $attenteValue = $row['selectionScolarite'] ? 'Reprendre cet enfant' : 'Mettre en attente';
                $attenteTitle = $row['selectionScolarite'] ? 'Remettre ' . $row['prenom'] . ' dans' : 'Retirer ' . $row['prenom'] . ' de';
                $attenteTitle .= ' la liste des inscriptions à payer';
                $buttons['attente'] = array(
                    'class' => 'button default left-10px',
                    'formaction' => $url_attente,
                    'title' => $attenteTitle,
                    'value' => $attenteValue
                );
            }
            $btligne = $this->listeLigneActions($row['eleveId'], $hiddens, $buttons);
            $modeleligne = '<tr class="%s"><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td><td>%s</td></tr>';
            echo sprintf($modeleligne, $this->cycle(array(
                "odd",
                "even"
            ))->next(), $row['nom'], $row['prenom'], $row['etablissement'], $row['communeEtablissement'], $montantUnitaire, $btligne);
        }
        ?>
            </tbody>
				<tfoot>
					<tr>
						<th colspan="4">Total à payer</th>
						<th><?php echo $fmt->formatCurrency($montantTotal, 'EUR'); ?></th>
					</tr>
				</tfoot>
			</table>
		</fieldset>
    <?php endif; ?>
        <div class="bouton-inscrire clearfix">
        <?php
    $boutons = array(
        array(
            'class' => 'button default float-right left-10px',
            'formaction' => $url_ajoutEleve,
            'value' => 'Inscrire un autre enfant'
        )
    );
    if ($montantTotal > 0) {
        if ($enAttente) {
            $payerTitle = "valider et payer toutes les incriptions\nqui ne sont pas en attente.";
        } else {
            $payerTitle = "valider et payer toutes les inscriptions\nde la liste de enfants préinscrits.";
        }
        $boutons['payer'] = array(
            'class' => 'button default float-right left-10px',
            'formaction' => $url_payer,
            'value' => 'Valider la liste et payer',
            'title' => $payerTitle
        );
    }
    echo $this->listeZoneActions(array(
        'montant' => $montantTotal
    ), $boutons);
    ?>
        </div>
	</div>
	<div id="parent-paiements">
    <?php if ($nbPaiements) : ?>
    <fieldset class="sbm-page1">
			<legend>Paiements enregistrés</legend>
			<table class="parent paiement">
				<tbody>
					<tr>
						<th>Date du paiement</th>
						<th>Moyen de paiement</th>
						<th>Montant</th>
					</tr>
            <?php
        foreach ($this->paiements as $row) {
            echo '<tr><td>' . DateLib::formatDateTimeFromMysql($row->datePaiement) . '</td><td>' . $row->modeDePaiement . '</td><td>' . $row->montant . '</td></tr>';
        }
        ?>
            </tbody>
			</table>
		</fieldset>
    <?php endif; ?>
    </div>
</div>
<?php endif; ?>