<?php
/**
 * Page de localisation d'une station
 *
 * La page présente une carte. Il suffit de cliquer sur la carte pour localiser la station
 * 
 * @project sbm
 * @package SbmGestion/view/sbm-gestion/transport
 * @filesource station-localisation.phtml
 * @encodage UTF-8
 * @author DAFAP Informatique - Alain Pomirol (dafap@free.fr)
 * @date 2 mai 2016
 * @version 2016-2.1.1
 */
// mise en place des JS de googleMaps
$this->headScript()->appendFile('https://maps.google.com/maps/api/js?sensor=false');
$this->headScript()->appendFile('/js/StyledMarker.js');
$this->headScript()->captureStart();
?>
var marker;
var tMarkers = new Array();
function initialiser() {
    var latlng = new google.maps.LatLng(<?php echo $this->config['centre']['lat'];?>, <?php echo $this->config['centre']['lng'];?>);
    // initialisation des paramètres de la carte
    var options = {
        center: latlng,
        zoom: <?php echo $this->config['zoom'];?>,
        //mapTypeId: google.maps.MapTypeId.ROADMAP
        mapTypeId: "OSM",
        mapTypeControl: true,
        mapTypeControlOptions: {
            mapTypeIds: [
                "OSM",
                //google.maps.MapTypeId.ROADMAP, 
                //google.maps.MapTypeId.SATELLITE, 
                google.maps.MapTypeId.HYBRID, 
                google.maps.MapTypeId.TERRAIN
            ],
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
        },
        streetViewControl: true
    };
    var oCarte = new google.maps.Map(document.getElementById('carte-inner'), options);
    // define OSM map type pointing at the OpenStreetMap tile server
    oCarte.mapTypes.set("OSM", new google.maps.ImageMapType({
        getTileUrl: function(coord, zoom) {
            return "http://tile.openstreetmap.org/" + zoom + "/" + coord.x + "/" + coord.y + ".png";
        },
        tileSize: new google.maps.Size(256,256),
        name: "OpenStreetMap",
        maxZoom: 18,
        opacity: 1,
        alt: "Carte OpenStreetMap"
    }));
    // info bulle
    var oInfo = new google.maps.InfoWindow();
    // placement des markers
    for (var i = 0; i < tMarkers.length; i++) {
        var optionsMarker = {
            'styleIcon': new StyledIcon(StyledIconTypes.BUBBLE,{color:tMarkers[i].color,text:tMarkers[i].text}),
            'map': oCarte,
            'position': new google.maps.LatLng( tMarkers[i].lat, tMarkers[i].lng),
            'numero': i,
            'title': tMarkers[i].title
        }
        var oMarker = new StyledMarker(optionsMarker);        
        // listeners
        google.maps.event.addListener(oMarker, 'click', function(data) {
            oInfo.setContent(tMarkers[this.numero].info);
            oInfo.open(this.getMap(), this);
        });
    }
    // initialisation du marker
    var optionsMarqueur = {
        map: oCarte,
        position: new google.maps.LatLng(document.getElementById('lat').value, document.getElementById('lng').value),
        title: 'point d\'arrêt'
    }
    marker = new google.maps.Marker(optionsMarqueur);
    
    var contentMarker = "<?php echo $this->description;?>";
 
    var infoWindow = new google.maps.InfoWindow({
        content  : contentMarker,
        position : latlng
    });
    google.maps.event.addListener(marker, 'click', function() {
        infoWindow.open(oCarte,marker);
    });
    
    google.maps.event.addListener(oCarte, 'click', function(event) {
        var latlng = event.latLng;
    	document.getElementById('lat').value = latlng.lat();
    	document.getElementById('lng').value = latlng.lng();
    	if (marker) {
    	   marker.setPosition(latlng);
    	} else {
    	   var optionsMarker = {
    	       map: oCarte,
    	       position: new google.maps.LatLng(latlng.lat(), latlng.lng()),
    	       title: 'point d\'arrêt'
    	   }
    	   marker = Marker(optionsMarker);
        }
    });
}

<?php 
$this->headScript()->captureEnd();
// lancement du script (sera affiché dans le layout à la fin de la page
$i = 0;
$tMarkers = "[\n";
foreach ($this->ptStations as $pt) {
    $e = $pt->getAttribute('station');
    if ($e->ouverte) {
        $color = "#00ff00";
        $nature = "ouverte";
    } else {
        $color = "#ff0000";
        $nature = "fermée";
    }
    $d = array(
        '<b>' . $this->escapeHtml($e->nom) . '</b>',
        implode(' ', array(
            $e->codePostal,
            $e->commune
        ))
    );

    $tMarkers .= '{"lat":' . $pt->getLatitude() . ',"lng":' . $pt->getLongitude() . ',"color":"' . $color . '","text":"S","title":"' . $e->nom . '","info":"' . implode('<br>', $d) . "\"},\n";
}
$tMarkers .= ']';
$this->inlineScript()->captureStart(); 
?>
tMarkers = <?php echo $tMarkers;?>;
initialiser();
<?php $this->inlineScript()->captureEnd(); ?>
<h1>Position d'une station sur la carte</h1>
<div id="carte-wrapper">
	<div id="carte-header" class="clearfix">
	    <div class="float-left"><ul style="margin-top:0;"><?php foreach ($this->station as $ligne) echo '<li>' . $ligne . '</li>'; ?></ul></div>
		<div class="float-right left-10px" style="max-width: 700px;">
			Cliquez sur la carte à l'emplacement de la station puis cliquez
			sur le bouton <b>'Enregistrer la localisation'</b>. Utilisez le zoom pour plus de précision.<br>
			<?php echo $this->form($this->form); ?>
		</div>

</div>
	<div id="carte-inner"
		style="width: 90%; height: 500px; margin-left: auto; margin-right: auto; margin-top: 20px; margin-bottom: 20px;"></div>
</div> 
 